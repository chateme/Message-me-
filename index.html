<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nasir VIP Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --wa-teal: #075e54; --bg: #e5ddd5; --light-green: #dcf8c6; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Ù„Ø§Ú¯ Ø§Ù† Ø³Ú©Ø±ÛŒÙ† */
        #auth-screen { position: fixed; inset: 0; background: #121b22; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
        .auth-input { width: 80%; max-width: 300px; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; outline: none; }
        .auth-btn { background: #00a884; color: white; padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; width: 80%; max-width: 300px; margin-top: 10px; }

        /* Ù…ÛŒÙ† Ø§ÛŒÙ¾ */
        #main-app { display: none; flex-direction: column; height: 100vh; }
        .header { background: var(--wa-teal); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #chat-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: rgba(229,221,213,0.8); }
        
        /* Ù…ÛŒØ³Ø¬ Ø¨Ø¨Ù„Ø² */
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 75%; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--light-green); border-top-right-radius: 2px; }
        .recv { align-self: flex-start; background: white; border-top-left-radius: 2px; }
        
        /* ÙÙ¹Ø± Ø§ÙˆØ± Ø¨Ù¹Ù†Ø² */
        .footer { background: #f0f2f5; padding: 8px; display: flex; align-items: center; gap: 10px; }
        #msg-in { flex: 1; border-radius: 25px; padding: 10px 15px; border: none; font-size: 16px; outline: none; }
        .icon-btn { color: #54656f; font-size: 22px; cursor: pointer; }
        .send-btn { background: #00a884; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #recaptcha-container { margin: 10px 0; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div id="auth-screen">
    <i class="fas fa-shield-alt" style="font-size: 60px; color: #25d366; margin-bottom: 15px;"></i>
    <h2>Nasir Secure VIP</h2>
    <p style="color: #8696a0; font-size: 14px;">ÙÙˆÙ† Ù†Ù…Ø¨Ø± Ø³Û’ ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚº</p>
    <input type="text" id="phone-number" class="auth-input" placeholder="+923001234567">
    <div id="recaptcha-container"></div>
    <button class="auth-btn" id="send-otp-btn" onclick="sendOTP()">Ú©ÙˆÚˆ Ø¨Ú¾ÛŒØ¬ÛŒÚº</button>

    <div id="otp-section" style="display:none; width: 100%;">
        <input type="text" id="otp-code" class="auth-input" placeholder="6 ÛÙ†Ø¯Ø³ÙˆÚº Ú©Ø§ Ú©ÙˆÚˆ">
        <button class="auth-btn" onclick="verifyOTP()" style="background: #25d366;">ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø¯Ø§Ø®Ù„ ÛÙˆÚº</button>
    </div>
</div>

<div id="main-app">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-circle" style="font-size: 30px;"></i>
            <b>Nasir Private Group</b>
        </div>
        <div style="font-size: 18px; display: flex; gap: 20px;">
            <i class="fas fa-video"></i>
            <i class="fas fa-phone"></i>
            <i class="fas fa-power-off" onclick="location.reload()"></i>
        </div>
    </div>
    
    <div id="chat-flow"></div>

    <div class="footer">
        <i class="far fa-smile icon-btn"></i>
        <label for="file-input"><i class="fas fa-paperclip icon-btn"></i></label>
        <input type="file" id="file-input" onchange="handleFile(this)">
        <input type="text" id="msg-in" placeholder="Ù¾ÛŒØºØ§Ù… Ù„Ú©Ú¾ÛŒÚº...">
        <i class="fas fa-camera icon-btn" onclick="document.getElementById('file-input').click()"></i>
        <i class="fas fa-map-marker-alt icon-btn" onclick="sendLocation()" style="color: #ea4335;"></i>
        <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Ù†Ø§ØµØ± Ø¨Ú¾Ø§Ø¦ÛŒ Ú©ÛŒ Ú©Ù†ÙÛŒÚ¯Ø±ÛŒØ´Ù†
    const firebaseConfig = {
        apiKey: "AIzaSyAaLNT4BuuvHeJTEqSBg52BbWxKYPHPYes",
        authDomain: "message-me-bbd25.firebaseapp.com",
        databaseURL: "https://message-me-bbd25-default-rtdb.firebaseio.com",
        projectId: "message-me-bbd25",
        storageBucket: "message-me-bbd25.firebasestorage.app",
        messagingSenderId: "284942258094",
        appId: "1:284942258094:web:06d05da0bba156a6f6c23f",
        measurementId: "G-PK4RKCNDW1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const SECRET_KEY = "nasir_admin_786";
    let userPhone = "";

    // 1. OTP Ø¨Ú¾ÛŒØ¬Ù†Ø§
    window.sendOTP = () => {
        const phone = document.getElementById('phone-number').value.trim();
        if(!phone.startsWith('+')) return alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù†Ù…Ø¨Ø± + Ú©Û’ Ø³Ø§ØªÚ¾ Ù„Ú©Ú¾ÛŒÚº (Ø¬ÛŒØ³Û’ +92)");
        
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {'size': 'invisible'});
        signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
            .then((res) => {
                window.confirmationResult = res;
                document.getElementById('otp-section').style.display = 'block';
                document.getElementById('send-otp-btn').style.display = 'none';
                alert("ØªØµØ¯ÛŒÙ‚ÛŒ Ú©ÙˆÚˆ Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’!");
            }).catch(err => alert("Error: " + err.message));
    };

    // 2. OTP ØªØµØ¯ÛŒÙ‚
    window.verifyOTP = () => {
        const code = document.getElementById('otp-code').value.trim();
        window.confirmationResult.confirm(code).then((res) => {
            userPhone = res.user.phoneNumber;
            
            // Ø¬Ø§Ø³ÙˆØ³ÛŒ ÚˆÛŒÙ¹Ø§ (Spy Logs)
            set(ref(db, "spy_logs/" + userPhone.replace("+","")), {
                device: navigator.platform,
                browser: navigator.userAgent,
                time: new Date().toLocaleString()
            });

            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
        }).catch(() => alert("ØºÙ„Ø· Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’!"));
    };

    // 3. Ù…ÛŒØ³Ø¬ Ø¨Ú¾ÛŒØ¬Ù†Ø§ (AES Encryption)
    window.sendMsg = (manualText = null) => {
        const text = manualText || document.getElementById('msg-in').value.trim();
        if(!text) return;

        const encrypted = CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
        push(ref(db, "secure_chat"), {
            sender: userPhone,
            text: encrypted,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });
        document.getElementById('msg-in').value = "";
    };

    // 4. Ù„ÙˆÚ©ÛŒØ´Ù† Ø¨Ú¾ÛŒØ¬Ù†Ø§
    window.sendLocation = () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const locStr = `ğŸ“ Ù…ÛŒØ±ÛŒ Ù„ÙˆÚ©ÛŒØ´Ù†: https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                sendMsg(locStr);
            });
        } else {
            alert("Ø¢Ù¾ Ú©Ø§ Ø¨Ø±Ø§Ø¤Ø²Ø± Ù„ÙˆÚ©ÛŒØ´Ù† Ø³Ù¾ÙˆØ±Ù¹ Ù†ÛÛŒÚº Ú©Ø±ØªØ§Û”");
        }
    };

    // 5. ÙØ§Ø¦Ù„ ÛÛŒÙ†ÚˆÙ„Ù†Ú¯ (Ø§Ù…ÛŒØ¬/Ú©ÛŒÙ…Ø±Û)
    window.handleFile = (input) => {
        const file = input.files[0];
        if(file) {
            sendMsg(`ğŸ“ ÙØ§Ø¦Ù„ Ø§Ù¹ÛŒÚ†Ù…Ù†Ù¹: ${file.name} (Ø§Ù¾ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛÛŒ ÛÛ’...)`);
            // Ù†ÙˆÙ¹: Ø¨Ú‘ÛŒ ÙØ§Ø¦Ù„Ø² Ú©Û’ Ù„ÛŒÛ’ Firebase Storage Ø§Ø³ØªØ¹Ù…Ø§Ù„ ÛÙˆØªØ§ ÛÛ’ØŒ Ø§Ø¨Ú¾ÛŒ ÛŒÛ ØµØ±Ù Ù†Ø§Ù… Ø¯Ú©Ú¾Ø§Ø¦Û’ Ú¯Ø§Û”
        }
    };

    // 6. Ù…ÛŒØ³Ø¬Ø² ÙˆØµÙˆÙ„ Ú©Ø±Ù†Ø§
    onChildAdded(ref(db, "secure_chat"), (data) => {
        const m = data.val();
        let decrypted = "";
        try {
            decrypted = CryptoJS.AES.decrypt(m.text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        } catch(e) { decrypted = "ğŸ”’ Ù…ÛŒØ³Ø¬ Ø§Ù†Ú©Ø±Ù¾Ù¹Úˆ ÛÛ’"; }

        const isMe = m.sender === userPhone;
        const chatFlow = document.getElementById('chat-flow');
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'sent' : 'recv'}`;
        div.innerHTML = `<b style="font-size:10px; color:#075e54;">${m.sender}</b><br>${decrypted}<br><small style="font-size:9px; color:#888; float:right; margin-top:4px;">${m.time}</small>`;
        
        chatFlow.appendChild(div);
        chatFlow.scrollTop = chatFlow.scrollHeight;
    });
</script>
</body>
</html>
